# Hasura Backend

## Hasura Installation
1. [Install Hasura using Docker](https://hasura.io/docs/1.0/graphql/core/getting-started/docker-simple.html)
2. Start Hasura using docker 
3. Navigate to `http://localhost:8080/` - this is your Hasura GUI
4. Set .env variables (you can get these from the docker yml file)
    
    * GQL_ENGINE_URI = "http://localhost:8080/v1/graphql"
    * GQL_ENGINE_ACCESS_KEY = "myadminsecretkey"
    * DB_NAME="postgres"
    * DB_TYPE = "postgres"
    * DB_HOST="172.18.0.2" (find out your postgres ip address by running `docker inspect <Container-ID>` 
    where container id is the id of your postgres container, run `docker ps` to find id)
    * DB_PORT=5432
    * DB_USERNAME="postgres"
    * DB_PASSWORD="postgrespassword"
    * DB = "postgres"
5. In `app.module.ts` set `const resetDb = true;`, then run `nx serve api-external`. This will generate the postgres 
schema in postgres DB running inside the docker container and seed the DB using `seed-db.service`.
6. Stop the NestJS server by pressing `Ctrl+C` in terminal
7. In `app.module.ts` set `const resetDb = false;` and save
8. Navigate to http://localhost:8080/console/data/schema/public You will see 2 tables (food, restaurant) in `Untracked tables or views`.
Tracked tables is what will generate GraphQL Resolvers. We can either manually track them by clicking `track all` or by
importing the Hasura metadata JSON file. If you choose to manually track these tables, you have to click on each table
and click on `Relationships` tab and define object relationships. Those are needed for GraphQL queries to get all foods 
that belong to a particular restaurant. Those are essentially GraphQL resolvers for relationships
9. Navigate to http://localhost:8080/console/settings/metadata-actions and click `Import metadata` and select the file 
at `apps/api/external/hasura_metadata.json`
10. run `nx serve api-external`. This will fetch remote Hasura GraphQL Schema and merge it with the local GraphQL Schema
11. Navigate to http://localhost:3333/graphql and click on `Schema`. Under 
    ```type Query {
      ping: String!
      food(
        distinct_on: [food_select_column!]
        limit: Int
        offset: Int
        order_by: [food_order_by!]
        where: food_bool_exp
      ): [food!]!
      }```
12. `ping` Query is located in `health.resolver.ts` - this is our local query using code-first approach.
`food` query is generated by Hasura and is stitched together on server start
